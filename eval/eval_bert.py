import math
import numpy as np
from sacrebleu import sentence_chrf
import bert_score

# 初始化 BERTScorer
bert_scorer = bert_score.BERTScorer(model_type="roberta-large", lang="en", rescale_with_baseline=True)

def column_to_row_format(table):
    """将列式存储的表格转换为行式存储"""
    rows = []
    columns = list(table.keys())
    num_rows = len(table[columns[0]]) if columns else 0
    
    for i in range(num_rows):
        row = {}
        for col in columns:
            # 确保使用字符串类型的键
            row[col] = table[col][i] if i < len(table[col]) else "None"
        rows.append(row)
    return rows

def flatten_table(table):
    """将表格展平为一个集合，每个元素是 (row_idx, col, value) 的元组，None 值也包含在内"""
    flattened = set()
    for row_idx, row_data in enumerate(table):
        for col, value in row_data.items():
            if value == "None":
                value = "None"  # 保持一致性
            flattened.add((row_idx, col, value))
    return flattened

def calc_similarity_matrix(tgt_data, pred_data, metric):
    """计算相似度矩阵"""
    def calc_data_similarity(tgt, pred):
        # 提取元组中的 value 部分
        tgt_value = tgt[2]  # (row_idx, col, value) 中的 value
        pred_value = pred[2]  # (row_idx, col, value) 中的 value

        # 如果 tgt_value 或 pred_value 为 None，返回默认值 0
        if tgt_value is None or pred_value is None:
            return 0.0

        if metric == 'E':
            return int(tgt_value == pred_value)
        elif metric == 'c':
            # 如果输入为空字符串，返回默认值 0
            if not tgt_value or not pred_value:
                return 0.0
            try:
                return sentence_chrf(pred_value, [tgt_value]).score / 100
            except:
                return 0.0
        elif metric == 'BS-scaled':
            try:
                ret = bert_scorer.score([pred_value], [tgt_value])[2].item()
                return max(ret, 0)
            except:
                return 0.0
        else:
            raise ValueError(f"Metric cannot be {metric}")

    ret_table = []
    for tgt in tgt_data:
        temp = []
        for pred in pred_data:
            temp.append(calc_data_similarity(tgt, pred))
        ret_table.append(temp)
    return np.array(ret_table, dtype=np.float64)

def metrics_by_sim(tgt_data, pred_data, metric):
    """基于相似度矩阵计算 Precision、Recall 和 F1 分数"""
    sim = calc_similarity_matrix(tgt_data, pred_data, metric)
    try:
        prec = np.mean(np.max(sim, axis=0))
        recall = np.mean(np.max(sim, axis=1))
    except ValueError:
        prec = 1
        recall = 1

    if prec + recall == 0.0:
        f1 = 0.0
    else:
        f1 = 2 * prec * recall / (prec + recall)
    return prec, recall, f1

def main(true_table, pred_table):
    """主函数，计算并输出结果"""
    true_set = flatten_table(true_table)
    pred_set = flatten_table(pred_table)
    
    metrics = ['E', 'c', 'BS-scaled']
    for metric in metrics:
        precision, recall, f1 = metrics_by_sim(true_set, pred_set, metric)
        print(f"Metric: {metric}")
        print(f"Precision: {precision:.4f}, Recall: {recall:.4f}, F1 Score: {f1:.4f}")
        print()

# 示例数据结构
data = {"id": "e7012ad8-e8bc-4b7a-9d56-e8127e6f47d8", "table": {"ID": [1863298208937099841, 1863298208936111190, 1863298208936111145, 1863298208936111146, 1863298208936111147, 1863298208936111149, 1863298208936111148, 1863298208936111150, 1863298208936111151, 1863298208936111152], "采购项目名称": ["宜宾市自然灾害应急能力提升工程基层防灾项目（第二批）（消防水泵救援类）", "四川省大英县育才中学2024年普通高中教育补助资金项目（实验室设备采购）（第四次）询价公告", "电子科技大学模拟异构硬件仿真加速设备采购项目", "物业管理服务（第四办公区）采购项目", "马尔康市大郎足沟流域集中式饮用水水源地规范化建设项目（机房采购设备类）(四次)", "四川省政府采购一体化平台省级运营服务", "绵竹市2024年绿色种养循环农业试点项目试验、监测服务采购", "国家税务总局高县税务局2025年非执法类税收辅助性服务采购项目", "泸州市智慧城市和信息化项目2024年采购（第一批）(二次)", "设备更新项目（中央空调系统设备）(二次)"], "采购单位": ["宜宾市应急管理局", "四川省大英县育才中学　", "电子科技大学", "成都市武侯区机关事务中心", "阿坝藏族羌族自治州马尔康生态环境局", "四川省财政厅", "绵竹市农业农村局", "国家税务总局宜宾市税务局", "泸州市发展和改革委员会", "泸州市博物馆"], "公告时间": ["2024/12/30 17:47", "2024/12/29 17:03", "2024/12/28 16:34", "2024/12/27 22:28", "2024/12/27 21:19", "2024/12/27 21:05", "2024/12/27 21:05", "2024/12/27 20:10", "2024/12/27 19:57", "2024/12/27 19:50"], "获取招标文件时间": ["2024年12月31日至2025年01月07日\n每日上午:00:00 至 12:00??下午:12:00 至 23:59（北京时间，法定节假日除外）", None, None, None, None, None, None, None, "2024年12月28日至2025年01月06日\n每日上午:00:00 至 12:00??下午:12:00 至 23:59（北京时间，法定节假日除外）", "2024年12月28日至2025年01月06日\n每日上午:00:00 至 12:00??下午:12:00 至 23:59（北京时间，法定节假日除外）"], "招标文件售价": ["￥0", None, None, None, None, None, None, None, "￥0", "￥0"], "获取招标文件地点": ["项目电子化交易系统-投标（响应）管理-未获取采购文件中选择本项目获取招标文件", None, None, None, None, None, None, None, "项目电子化交易系统-投标（响应）管理-未获取采购文件中选择本项目获取招标文件", "项目电子化交易系统-投标（响应）管理-未获取采购文件中选择本项目获取招标文件"], "开标时间": ["2025年01月21日 10:00", None, None, "0002年11月30日 00:00", None, None, None, None, "2025年01月17日 09:30", "2025年01月17日 09:30"], "开标地点": ["通过项目电子化交易系统-开标/开启大厅参与开标", None, None, None, None, None, None, None, "通过项目电子化交易系统-开标/开启大厅参与开标", "通过项目电子化交易系统-开标/开启大厅参与开标"], "预算金额": ["￥604.061300万元（人民币）", "￥25.368800万元（人民币）", None, "详见公告正文", None, None, None, None, "￥1700.000000万元（人民币）", "￥579.650000万元（人民币）"], "项目联系人": ["曹老师", "田女士", "张老师", "陈旭", "马老师", "张先生", "房健明", "丁女士", "李女士", "罗敏"], "项目联系电话": ["08313883106", "0825-2280987", "028-87789977", "028-61069825", "028-67836181", "028-87050033-2052", "13658167010", "0831-8206209", "0830-2688731", "0830-6665625"], "采购单位地址": ["宜宾市叙州区南广路197号", "四川省大英县育才中学　", "四川省成都市高新区（西区）西源大道2006号", "成都市武侯区浆洗街街道武侯祠大街264号", "马尔康市达尔玛街201号", "四川省成都市锦江区南新街37号", "绵竹市剑南镇安顺路80号", "四川省宜宾市叙州区赵场街道金沙江大道5号", "泸州市江阳区江阳西路一号市政府大院", "泸州市江阳区一环路龙透关路段151号"], "采购单位联系方式": ["08313883106", "庄英豪 、15681921353", "鲁老师 028-61830809-802", "028-85559693", "18383042892", "028-86723190", "13658103927", "0831-8206209", "18160070696", "0830-3196651"], "代理机构名称": ["宜宾市政府采购中心", "四川祥跃项目管理有限公司", "四川中泽盛世招标代理有限公司", "成都市武侯区政府采购中心", "阿坝藏族羌族自治州政府采购中心", "四川中意招标有限公司", "成都农交所德阳农村产权交易有限公司", "详见公告正文", "泸州发展国际项目咨询有限公司", "四川哲胜招标代理有限公司"], "代理机构地址": ["四川省宜宾市叙州区南岸金沙江大道市民中心四楼", "遂宁市船山区遂州中路600号1层", "四川省成都市金牛区二环路西三段213号宏源大厦A座4楼", "成都市武侯区武科西五路360号武侯区市民中心2栋5单元5楼", "四川省成都市二环路西三段30号", "成都市高新区天府大道1700号新世纪环球中心E3门栋6楼2-1-611-615", "德阳市旌阳区泰山南路二段368号旌南大厦B区一层", "详见公告正文", "四川省泸州市龙马潭区四川自贸区川南临港片区西南商贸城17区四层126号", "泸州市江阳区学院西路301号3栋7楼"], "代理机构联系方式": ["08318088817", "田女士、0825-2280987", "项目负责：刘菁、喻宇；质控审核：宋伟；项目执行：张雨晴、文荟尧；询问、质疑、投诉受理：李静怡028-87789977", "028-61069825", "028-67836181", "028-87050033", "13658167010", "详见公告正文", "0830-2688731", "0830-6665625"]},"content":"","prediction":{
    "项目编号": [
        "N5115012024000618",
        "SCXY-2024-149号",
        "HW20240013901",
        "N5101072024000312",
        "N5132112024000348",
        "N5100012024004066",
        "N5106832024000209",
        "SC2024-ZXJC-C0281-B00",
        "N5105012024000507",
        "N5105012024000504"
    ],
    "采购项目名称": [
        "宜宾市自然灾害应急能力提升工程基层防灾项目（第二批）（消防水泵救援类）",
        "四川省大英县育才中学2024年普通高中教育补助资金项目（实验室设备采购）（第四次）询价公告",
        "电子科技大学模拟异构硬件仿真加速设备采购项目",
        "物业管理服务（第四办公区）采购项目",
        "马尔康市大郎足沟流域集中式饮用水水源地规范化建设项目（机房采购设备类）(四次)",
        "四川省政府采购一体化平台省级运营服务",
        "绵竹市2024年绿色种养循环农业试点项目试验、监测服务采购",
        "国家税务总局高县税务局2025年非执法类税收辅助性服务采购项目",
        "泸州市智慧城市和信息化项目2024年采购（第一批）(二次)",
        "设备更新项目（中央空调系统设备）(二次)"
    ],
    "采购方式": [
        "公开招标",
        "询价",
        "公开招标",
        "公开招标",
        "公开招标",
        "公开招标",
        "竞争性磋商",
        "竞争性磋商",
        "公开招标",
        "公开招标"
    ],
    "预算金额": [
        "6,040,613.00元",
        "25.368800 万元（人民币）",
        "500.0000000（万元）",
        "-",
        "268,988.00元",
        "1,950,000.00元",
        "743,800.00元",
        "108万元",
        "17,000,000.00元",
        "5,796,500.00元"
    ],
    "中标（成交）供应商": [
        "-",
        "-",
        "北京挚诚鼎泰科技发展有限公司",
        "-",
        "成都明智网络技术有限公司",
        "博思数采科技股份有限公司",
        "四川中衡检测技术有限公司",
        "四川中税答疑财税咨询服务有限公司",
        "-",
        "-"
    ],
    "合同履行期限": [
        "自合同签订之日起90日",
        "签订合同 30 日内交货",
        "-",
        "-",
        "-",
        "三年，合同一年一签",
        "自合同签订之日起365日",
        "2025年1月1日-2025年12月31日",
        "自合同签订之日起1095日",
        "自合同签订之日起100日内交货完工"
    ],
    "是否接受联合体投标": [
        "不接受联合体投标",
        "不接受联合体投标",
        "-",
        "不接受联合体投标",
        "-",
        "-",
        "-",
        "-",
        "不接受联合体投标",
        "不接受联合体投标"
    ],
    "公告期限": [
        "5个工作日",
        "3个工作日",
        "1个工作日",
        "1个工作日",
        "1个工作日",
        "1个工作日",
        "1个工作日",
        "1个工作日",
        "5个工作日",
        "5个工作日"
    ]
}}

# 将列式存储的表格转换为行式存储
true_table = column_to_row_format(data["table"])
pred_table = column_to_row_format(data["prediction"])

# 计算并输出结果
main(true_table, pred_table)

        
        